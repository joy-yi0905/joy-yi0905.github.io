<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>

  
  <meta name="author" content="易建勇,YI_joy">
  

  
  <meta name="description" content="a light blog with express and mongodb | 前端技术空间">
  

  
  <meta name="keywords" content="express mongodb nodejs建站">
  

  

  <title>使用express和mongodb搭建一个极简博客 | 前端技术空间</title>

  <link rel="stylesheet" href="/css/blog.css">
</head>
<body>

<div class="blog">

<div class="navigation">
  <ul class="nav-list">
    
      <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
    
      <li class="nav-item"><a class="nav-link" href="/archives">Archives</a></li>
    
  </ul>
</div>

<div class="post">

  <h1 class="post-title">使用express和mongodb搭建一个极简博客</h1>

  <time class="post-time">2016-04-09</time>

  <div class="post-content">
    <p>作为唯一一个与 JavaScript 相关的服务器编程语言，node.js 在web前端工程师中广受欢迎。它的语法接近 JavaScript，但它的运行环境却在服务端，node.js 可以做很多事，比如，最简单的可以做一个博客系统，也可以用它开发一个多人在线的游戏，还可以针对本地文件做一个自动化构建工具，以及数据爬虫、聊天室等各种应用。另外，它还拥有全球最大的开源生态系统（NPM）。</p>
<p>在我看来，要熟悉和了解node.js，没有什么比搭建一个博客系统更快、更有效了。<br><a id="more"></a></p>
<p>因此，本篇文章的目标很明确！用node.js搭建一个极简的博客系统。</p>
<p>为了更直观说明我们将要完成的事，首先来看下博客截图，分别是 博客首页 和 博客更新页：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/index-page.jpg" title="首页">
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/update-page.jpg" title="更新页">
<p>从以上博客截图，这是一个非常简洁的博客发布系统。主要有两个页面（首页和更新页），包含了发布博客、删除博客、更新博客和读取博客四个功能（即数据的增删改查）。</p>
<p>要搭建这样一个博客，毫无疑问，首先需要一门服务器语言，这里当然指的是node.js。但因为node.js书写起来比较原生，因此我们采用最流行、最成熟、最广泛的node.js框架-express。其次，要在后台记录数据，则需要数据库来支撑，在这里我们选用node.js的黄金搭档数据库-mongodb。</p>
<p>了解完博客的大体情况后，我们先熟悉需要用到的几项技术。</p>
<h2 id="一、express"><a href="#一、express" class="headerlink" title="一、express"></a>一、express</h2><p>要使用express，首先你得安装node.js，前往官网 <a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">https://nodejs.org/en/download/</a> 找到对应的系统和版本安装即可，这里不赘诉了。</p>
<p>而说到express，借用官网的一句话：</p>
<p>“Express 是一个基于 Node.js 平台的极简、灵活的 web 应用开发框架，它提供一系列强大的特性，帮助你创建各种 Web 和移动设备应用。”</p>
<p>简单来说，express封装了很多原生的node.js操作，通过安装后的express，可以调用路由、模板引擎、中间件等相关方法，从而很方便的写node.js。</p>
<p><strong>假设我们的项目在G盘，项目名称为 blog：</strong>，接着，我们来完成express安装、快速生成项目、依赖包安装，express项目启动等步骤。</p>
<h3 id="1-1-使用命令行全局安装express："><a href="#1-1-使用命令行全局安装express：" class="headerlink" title="1.1 使用命令行全局安装express："></a>1.1 使用命令行全局安装express：</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm install express-generator -g</span><br></pre></td></tr></table></figure>
<p>见截图：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/express-install.jpg" title="安装express">
<p>安装完成后，你可以通过以下命令来检测express的版本号：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; express -V</span><br></pre></td></tr></table></figure>
<h3 id="1-2-快速生成项目"><a href="#1-2-快速生成项目" class="headerlink" title="1.2 快速生成项目"></a>1.2 快速生成项目</h3><p>express给我们提供了一个命令，用于快速创建一个应用的文件以及相关目录。假设项目名称为 blog，则可以：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; express blog</span><br></pre></td></tr></table></figure>
<p>见截图：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/express-generate.jpg" title="快速创建项目">
<h3 id="1-3-进入项目并安装依赖"><a href="#1-3-进入项目并安装依赖" class="headerlink" title="1.3 进入项目并安装依赖"></a>1.3 进入项目并安装依赖</h3><p>创建完成项目后，我们运行命令行进入项目目录，并且安装express需要的依赖包：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; cd blog &amp;&amp; npm install</span><br></pre></td></tr></table></figure>
<p>见截图：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/express-npm-install.jpg" title="进入项目并安装依赖">
<h3 id="1-4-启动express"><a href="#1-4-启动express" class="headerlink" title="1.4 启动express"></a>1.4 启动express</h3><p>准备工作基本完成，接着我们通过以下命令启动express：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm start</span><br></pre></td></tr></table></figure>
<p>见截图：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/express-start.jpg" title="启动express">
<p>最后在浏览器中，打开 <a href="http://localhost:3000/，即可看到以下界面：" target="_blank" rel="noopener">http://localhost:3000/，即可看到以下界面：</a></p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/express-welcome.jpg" title="express欢迎界面">
<p>虽然我们成功搭建了express，但它启动后的默认界面与我们要的博客系统大相径庭，之后，我们会根据博客系统界面对express生成的默认文件进行相应修改和调整。</p>
<p>如果你想更多的了解它，也可以访问它的中文官网：<a href="http://www.expressjs.com.cn/" target="_blank" rel="noopener">http://www.expressjs.com.cn/</a></p>
<p>说完node.js的web框架express，接下来，我们来讲讲数据库。</p>
<h2 id="二、mongodb"><a href="#二、mongodb" class="headerlink" title="二、mongodb"></a>二、mongodb</h2><p>MongoDB 是一个基于分布式文件存储的数据库。由 C++ 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。 MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。</p>
<p>关系型数据库和非关系型数据库的结构对比如下：</p>
<table>
<thead>
<tr>
<th>数据库类型</th>
<th>一级结构</th>
<th>二级结构</th>
<th>三级结构</th>
<th>四级结构</th>
</tr>
</thead>
<tbody>
<tr>
<td>关系型数据库</td>
<td>表</td>
<td>一条记录</td>
<td>字段</td>
<td>值</td>
</tr>
<tr>
<td>非关系型数据库</td>
<td>集合</td>
<td>文档</td>
<td>键</td>
<td>值</td>
</tr>
</tbody>
</table>
<p>从表中可以知道，mongodb数据库是由集合组成，而集合是由文档组成，而文档是由一组组键值对组成。也就是说，mongodb中最小的单位为文档。</p>
<p>如果要细说mongodb，恐怕一本书的内容也很难将它讲完。因为本文只是做一个极简的博客系统，因此在这里只会描述mongodb的必要操作。</p>
<h3 id="2-1-数据库相关配置"><a href="#2-1-数据库相关配置" class="headerlink" title="2.1 数据库相关配置"></a>2.1 数据库相关配置</h3><h4 id="2-1-1-下载与安装"><a href="#2-1-1-下载与安装" class="headerlink" title="2.1.1 下载与安装"></a>2.1.1 下载与安装</h4><p>要使用mongodb，首先要安装它，安装它的方法与node.js.类似：</p>
<p>下载地址：<a href="https://www.mongodb.org/downloads#production" target="_blank" rel="noopener">https://www.mongodb.org/downloads#production</a></p>
<p>将压缩包解压后，然后安装到某个目录下，假设安装的路径为 D:\SEVER-SOFTWARE\SEVER\Mongodb</p>
<h4 id="2-1-2-配置环境变量"><a href="#2-1-2-配置环境变量" class="headerlink" title="2.1.2 配置环境变量"></a>2.1.2 配置环境变量</h4><p>通过配置环境变量，这样我们就可以在命令行的任何地方运行mongodb，而无需进入到mongodb中bin的目录。</p>
<p>配置的方法如下：</p>
<p>计算机-&gt;属性-&gt;高级系统设置-&gt;环境变量-&gt;底部变量中找到 path-&gt;编辑-&gt;在输入框最后加入分号-&gt;分号后面加 mongodb中bin的目录（D:\SEVER-SOFTWARE\SEVER\Mongodb\bin）</p>
<h4 id="2-1-3-设置数据存放目录"><a href="#2-1-3-设置数据存放目录" class="headerlink" title="2.1.3 设置数据存放目录"></a>2.1.3 设置数据存放目录</h4><p>每个项目都有保存数据的目录，我们之前创建的 blog 项目也不例外。我们在 blog 目录下，先创建一个 data 的文件夹，用于存放blog下的所有数据。</p>
<p>在任意目录打开命令行窗口，执行以下命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; mongod.exe --dbpath G:\blog\data</span><br></pre></td></tr></table></figure>
<p>运行完后，当看到命令窗口中出现类似 waiting for connections on port 27017 字符时，说明设置数据存放目录成功。并且此时，我们在 G:\blog\data 目录中会看到有 journal 和 mongod.lock 等文件。</p>
<h4 id="2-1-4-启动mongodb"><a href="#2-1-4-启动mongodb" class="headerlink" title="2.1.4 启动mongodb"></a>2.1.4 启动mongodb</h4><p>假设我们是第一次设置数据存放的目录，那么通过上述“设置数据存放目录”的步骤，你已经启动了mongodb。</p>
<p>但倘若我们已经设置了数据存放目录，则只需要在任意目录（一般直接 Win+R，然后输入 cmd 即可），通过以下相同的命令来启动mongodb：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; mongod.exe --dbpath G:\blog\data</span><br></pre></td></tr></table></figure>
<h3 id="2-2-数据的操作"><a href="#2-2-数据的操作" class="headerlink" title="2.2 数据的操作"></a>2.2 数据的操作</h3><p>要访问 blog 里数据，需要在数据存放目录（即 G:\blog\data）打开命令行。</p>
<p><strong>注意，数据库的操作前，需要先启动 mongodb（前面已介绍）。</strong></p>
<p>也就是说，操作数据库时，我们总共打开了两个命令面板。一个是启动 mongodb 的，另外一个是操作当前项目数据库的。而我们需要关注和处理的，只是操作数据库的命令面板。</p>
<p>对于操作数据库的命名面板，运行如下命令，连接数据库：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; mongo</span><br></pre></td></tr></table></figure>
<p>此时，在命令行中打印出了mongodb的版本号，并且默认连接的是 test 数据库。</p>
<p>接下来，我们来简单的说说数据库、集合、文档的相关操作。</p>
<h4 id="2-2-1-数据库操作"><a href="#2-2-1-数据库操作" class="headerlink" title="2.2.1 数据库操作"></a>2.2.1 数据库操作</h4><p>要查看本地有哪些数据库，只需要执行以下命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; show dbs</span><br></pre></td></tr></table></figure>
<p>若你要查看当前所操作的数据库，则需通过以下命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db</span><br></pre></td></tr></table></figure>
<p>当需要新建一个数据库，使用 <code>use DATABASE_NAME</code> 命令，此时本地会自动创建一个名为 DATABASE_NAME 的数据库，因此你无需特意创建数据库。以下是创建一个名为 blog 的数据库：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; use blog</span><br></pre></td></tr></table></figure>
<p>当你再次使用 show dbs 查看本地数据库时，会发现我们刚才创建的 blog 数据库并没有列出来，这是因为新创建的数据库需要执行相应的操作，比如插入文档等，才会被记录到本地。</p>
<p>接着，我们尝试着往 blog 数据库插入一个文档，此处的 post 是文档名称，后面会说到：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.post.insert(&#123;<span class="string">"content"</span>: <span class="string">"123"</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>此时命令行中会出现 WriteResult({“nInserted” : 1}) ，这表明我们插入数据成功，同时你会在数据存放目录里（G:\blog\data）看到新增了 blog.ns 和 blog.0 两个文件。</p>
<p>删除数据库，删除前需请切换到该数据库，否者的话，会默认删除 test 数据库。采用如下命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.dropDatabase()</span><br></pre></td></tr></table></figure>
<p>以上操作截图如下：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/mongodb-database.jpg" title="操作数据库">
<h4 id="2-2-2-集合操作"><a href="#2-2-2-集合操作" class="headerlink" title="2.2.2 集合操作"></a>2.2.2 集合操作</h4><p>不同集合组成了一个数据库。接下来，针对某一个数据库，来说说集合的操作。</p>
<p>要查看数据里的集合，可通过 show collections 命令，若当前数据库没有文档，则什么也不会输出，反之则输入对应的文档和 system.indexes</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; show collections</span><br></pre></td></tr></table></figure>
<p>以下命令创建一个名为 item 的集合：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.createCollection(<span class="string">'item'</span>)</span><br></pre></td></tr></table></figure>
<p>你也可以直接往集合里插入内容，和创建数据库一样，你无需像上面那样特意创建集合，因为当插入数据时，它就自动创建了一个集合。以下命令表示在数据库的 info 集合中，插入一个空文档，由于之前没创建过 info 集合，所以此时是自动新创建的。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.info.insert(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>以下命令删除一个名为 item 的集合：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.item.drop();</span><br></pre></td></tr></table></figure>
<p>以上操作截图如下：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/mongodb-collection.jpg" title="操作集合">
<h4 id="2-2-3-文档操作"><a href="#2-2-3-文档操作" class="headerlink" title="2.2.3 文档操作"></a>2.2.3 文档操作</h4><p>不同文档组成了一个集合，不同的集合组成了一个数据库。接下来，针对某一个数据库下的某个集合，来说说文档的操作。</p>
<p>在 post 的集合中，新增单条文档和多条文档，可通过以下命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.post.insert(&#123;<span class="string">"content"</span>: <span class="string">"123"</span>&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.post.insert([&#123;<span class="string">"content"</span>: <span class="string">"456"</span>&#125;, &#123;<span class="string">"content"</span>: <span class="string">"789"</span>&#125;])</span><br></pre></td></tr></table></figure>
<p>而查找文档，则分为全部查找和指定查询，以下命令表示查找post全部的文档：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.post.find()</span><br></pre></td></tr></table></figure>
<p>查找 content 为 456 的文档：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.post.find(&#123;&#125;, &#123;<span class="string">"content"</span>: <span class="string">"456"</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>至于修改文档，则可以通过以下命令，表示将 content 为 789 的文档修改为 abc：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.post.update(&#123;<span class="string">"content"</span>: <span class="string">"789"</span>&#125;, &#123;<span class="attr">$set</span>: &#123;<span class="string">"content"</span>: <span class="string">"abc"</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>最后，可通过如下命令删除文档：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; db.post.remove(&#123;<span class="string">"content"</span>: <span class="string">"abc"</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>以上命令表示删除 content 为 abc 的文档。</p>
<p>以上操作截图如下：</p>
<img src="/2016/04/09/a-light-blog-with-express-and-mongodb/mongodb-document.jpg" title="操作文档">
<p>当然，mongodb还有很多很复杂，很实用的shell指令。如前面所说，这里只是简单的说明一些项目必要的shell指令，因此不一一列出。</p>
<h2 id="三、改造express"><a href="#三、改造express" class="headerlink" title="三、改造express"></a>三、改造express</h2><p>前面我们说到，启动后的 express 界面和我们的要搭建的博客UI不一致，因此我们要针对它生成的文件做相应修改和调整。</p>
<p>先来看下生成的目录：</p>

<ul>
<li>bin：存放express内部指令</li>
<li>data：我们自己定义存放数据的文件</li>
<li>node_modules：依赖包</li>
<li>public：一些静态资源，比如公用的js、css、image</li>
<li>routes：存放路由文件，可设置页面之间的跳转，以及页面载入时需执行的代码</li>
<li>views：存放视图文件，即页面模板</li>
<li>app.js：项目的入口文件</li>
<li>package.json：项目的配置文件</li>
</ul>
<p>首先，我们首先来修改页面模板。打开 views 文件夹，你会发现有三个 .jade 文件。它是express框架的默认模板引擎，或许你和我一样，对它里面html的写法非常无感（曾经我被里面的空格错误困扰了好半天）。相比而言，我们更喜欢用 html 文件来渲染页面。嗯，那我们先着手修改掉它的模板引擎：</p>
<h3 id="3-1-修改模板引擎"><a href="#3-1-修改模板引擎" class="headerlink" title="3.1 修改模板引擎"></a>3.1 修改模板引擎</h3><p>为了能让 html 文件作为 express 渲染页面的模板，因此我们决定采用 ejs 模板引擎，因为它和html是相互兼容的。要使用它，先安装：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm install ejs --save</span><br></pre></td></tr></table></figure>
<p>然后是在app.js里修改模板引擎，在根目录的app.js中，有关模板引擎的是这么两句：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// view engine setup</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);</span><br></pre></td></tr></table></figure>
<p>第一句：设置模板的路径是在根目录(__dirname)下的views文件夹<br>第二句：将模板引擎设置为以.jade为后缀名的文件</p>
<p>我们需要做的是，将上面两句修改为以下三句，即可：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// view engine setup</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'html'</span>);</span><br><span class="line">app.engine(<span class="string">'html'</span>, <span class="built_in">require</span>(<span class="string">"ejs"</span>).__express);</span><br></pre></td></tr></table></figure>
<p>然后将 views 文件下的 jade 文件全部删除，并新增 index.html、update.html、error.html 三个html文件。</p>
<p>三个页面的代码分别如下：</p>
<p><strong>index.html</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"/stylesheets/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">name</span> %&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>update.html</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"/stylesheets/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">name</span> %&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>error.html</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>错误页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"/stylesheets/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span>错误！<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>或许你会好奇 <code>&lt;%= title %&gt;</code> 这样的标签，它正是模板所特有的，它的值是通过后台传至前台，然后再渲染出来。详见 <a href="http://www.embeddedjs.com/" target="_blank" rel="noopener">http://www.embeddedjs.com/</a></p>
<h3 id="3-2-设置路由"><a href="#3-2-设置路由" class="headerlink" title="3.2 设置路由"></a>3.2 设置路由</h3><p>要使得以上3个页面能正常访问，需要在 routes 文件下设置路由。先删除 routes 下的所有js文件，然后再新增 index.js 和 update.js 文件（这里无需error.js，因为在app.js里有写）。</p>
<p>两个js文件代码分别如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'博客首页'</span>, <span class="attr">name</span>: <span class="string">'博客'</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p><strong>update.js</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET update page. */</span></span><br><span class="line">router.get(<span class="string">'/update'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.render(<span class="string">'update'</span>, &#123; <span class="attr">title</span>: <span class="string">'博客更新页'</span>, <span class="attr">name</span>: <span class="string">'博客更新'</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>接着，我们在根目录的 app.js 里设置相应的路由：</p>
<p>将 app.js 里的：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> routes = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span>, routes);</span><br><span class="line">app.use(<span class="string">'/users'</span>, users);</span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> update = <span class="built_in">require</span>(<span class="string">'./routes/update'</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span>, index);</span><br><span class="line">app.use(<span class="string">'/'</span>, update);</span><br></pre></td></tr></table></figure>
<p>最后，检验下我们的成果。在项目根目录打开命令行面板，输入以下命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm start</span><br></pre></td></tr></table></figure>
<p>在浏览器里打开 <a href="http://localhost:3000/，http://localhost:3000/update，" target="_blank" rel="noopener">http://localhost:3000/，http://localhost:3000/update，</a> 便可以看到博客首页、博客更新页。</p>
<p>而 <a href="http://localhost:3000/error" target="_blank" rel="noopener">http://localhost:3000/error</a> 、<a href="http://localhost:3000/abc" target="_blank" rel="noopener">http://localhost:3000/abc</a> 之类的则会定向到错误页。</p>

<h3 id="3-3-调整模板"><a href="#3-3-调整模板" class="headerlink" title="3.3 调整模板"></a>3.3 调整模板</h3><p>好了，我们接着调整index.html、update.html页面，以及public里stylesheets目录下的css文件，将首页和更新页的UI界面调整成文章开头处的博客系统UI界面。并在public里javascripts目录下新增jquery.min.js文件。</p>
<p>index.html里新增代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"blog-add"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"blog-textarea"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">"textarea-add"</span> <span class="attr">cols</span>=<span class="string">"30"</span> <span class="attr">rows</span>=<span class="string">"10"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-action"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn-publish"</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span>&gt;</span>发布<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"blog"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"blog-list"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"blog-item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-content"</span>&gt;</span>你好<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-extra"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"date"</span>&gt;</span>2015-10-10<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"delete"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"update"</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>update.html里新增代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"blog-add"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"blog-textarea"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">"textarea-add"</span> <span class="attr">cols</span>=<span class="string">"30"</span> <span class="attr">rows</span>=<span class="string">"10"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-action"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn-update"</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>调整后的css：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">* &#123;<span class="attribute">margin</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">0</span>;&#125;</span><br><span class="line"><span class="selector-tag">body</span> &#123;<span class="attribute">padding</span>: <span class="number">50px</span>;<span class="attribute">font</span>: <span class="number">14px</span> <span class="string">"Lucida Grande"</span>, Helvetica, Arial, sans-serif;&#125;</span><br><span class="line"><span class="selector-tag">a</span> &#123;<span class="attribute">color</span>: <span class="number">#00B7FF</span>;&#125;</span><br><span class="line"><span class="selector-tag">li</span> &#123;<span class="attribute">list-style</span>: none;&#125;</span><br><span class="line"><span class="selector-tag">a</span> &#123;<span class="attribute">text-decoration</span>: none;&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.blog-add</span> <span class="selector-class">.blog-textarea</span> &#123;<span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span> <span class="number">10px</span>;<span class="attribute">padding</span>: <span class="number">10px</span>;<span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ccc</span>;&#125;</span><br><span class="line"><span class="selector-class">.blog-add</span> <span class="selector-class">.textarea-add</span> &#123;<span class="attribute">width</span>: <span class="number">100%</span>;<span class="attribute">height</span>: <span class="number">80px</span>;<span class="attribute">border</span>: none;<span class="attribute">resize</span>: none;<span class="attribute">outline</span>: none;&#125;</span><br><span class="line"><span class="selector-class">.blog-add</span> <span class="selector-class">.blog-action</span> &#123;<span class="attribute">line-height</span>: <span class="number">30px</span>;<span class="attribute">text-align</span>: right;&#125;</span><br><span class="line"><span class="selector-class">.blog-add</span> <span class="selector-class">.blog-action</span> <span class="selector-class">.btn-publish</span>,</span><br><span class="line"><span class="selector-class">.blog-add</span> <span class="selector-class">.blog-action</span> <span class="selector-class">.btn-update</span> &#123;<span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#00B7FF</span>;<span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">20px</span>;<span class="attribute">border-radius</span>: <span class="number">3px</span>;&#125;</span><br><span class="line"><span class="selector-class">.blog-list</span> <span class="selector-class">.blog-item</span> &#123;<span class="attribute">padding-top</span>: <span class="number">10px</span>;<span class="attribute">line-height</span>: <span class="number">22px</span>;&#125;</span><br><span class="line"><span class="selector-class">.blog-list</span> <span class="selector-class">.blog-item</span> <span class="selector-tag">p</span> &#123;<span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">0</span>;<span class="attribute">word-wrap</span>: break-word;&#125;</span><br><span class="line"><span class="selector-class">.blog-list</span> <span class="selector-class">.blog-item</span> &#123;<span class="attribute">border-bottom</span>: <span class="number">1px</span> dotted <span class="number">#ddd</span>;&#125;</span><br><span class="line"><span class="selector-class">.blog-list</span> <span class="selector-class">.blog-extra</span> &#123;<span class="attribute">overflow</span>: hidden;<span class="attribute">color</span>: <span class="number">#999</span>;<span class="attribute">text-align</span>: right;&#125;</span><br><span class="line"><span class="selector-class">.blog-list</span> <span class="selector-class">.blog-extra</span> <span class="selector-class">.date</span> &#123;<span class="attribute">float</span>: left;&#125;</span><br><span class="line"><span class="selector-class">.blog-list</span> <span class="selector-class">.blog-extra</span> <span class="selector-tag">a</span> &#123;<span class="attribute">border-right</span>: <span class="number">1px</span> dotted <span class="number">#00B7FF</span>;<span class="attribute">padding</span>: <span class="number">0</span> <span class="number">10px</span>;<span class="attribute">margin-right</span>: -<span class="number">6px</span>;<span class="attribute">font-size</span>: <span class="number">12px</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>最后，得到静态的首页和更新页：</p>

<h2 id="四、express与mongodb交互"><a href="#四、express与mongodb交互" class="headerlink" title="四、express与mongodb交互"></a>四、express与mongodb交互</h2><p>通过上面的一系列操作，界面和页面路由都已经完成！接下来，就来到最重要的页面交互和数据操作了，好紧张。</p>
<p>我们先来理下交互流程，在首页中，我们点击 ‘发布’ 按钮，将文本框里的内容发送至后台，后台语言将数据保存到数据库，然后页面刷新，从数据库中读取博客数据，最后，将数据显示到页面。</p>
<h3 id="4-1-发送数据至后台"><a href="#4-1-发送数据至后台" class="headerlink" title="4.1 发送数据至后台"></a>4.1 发送数据至后台</h3><p>前台给后台发送数据，当然首选ajax，在 index.html 新增js代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"/javascripts/jquery.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发布</span></span><br><span class="line">    $(<span class="string">'.btn-publish'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> blogContent = $(<span class="string">'.textarea-add'</span>).val().trim().replace(<span class="regexp">/\n/g</span>, <span class="string">'&lt;br/&gt;'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!blogContent) &#123;</span><br><span class="line">            alert(<span class="string">'内容不能为空!'</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>(),</span><br><span class="line">            yy = date.getFullYear(),</span><br><span class="line">            MM = date.getMonth() + <span class="number">1</span>,</span><br><span class="line">            dd = date.getDate(),</span><br><span class="line">            hh = date.getHours(),</span><br><span class="line">            mm = date.getMinutes(),</span><br><span class="line">            ss = date.getSeconds();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> postData = &#123;</span><br><span class="line">            <span class="string">'content'</span>: blogContent,</span><br><span class="line">            <span class="string">'date'</span>: yy + <span class="string">'-'</span> + MM + <span class="string">'-'</span> + dd + <span class="string">' '</span> + hh + <span class="string">':'</span> + mm + <span class="string">':'</span> + ss</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        $.ajax(&#123; </span><br><span class="line">            url: <span class="string">'/'</span>,</span><br><span class="line">            type: <span class="string">'post'</span>,</span><br><span class="line">            data: postData,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                alert(<span class="string">'发布成功！'</span>);</span><br><span class="line">                location.href = <span class="string">'/'</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123; </span><br><span class="line">                alert(<span class="string">'发布失败！'</span>);</span><br><span class="line">                location.href = <span class="string">'error'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;); </span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-node-js接收数据并将数据保存到数据库"><a href="#4-2-node-js接收数据并将数据保存到数据库" class="headerlink" title="4.2 node.js接收数据并将数据保存到数据库"></a>4.2 node.js接收数据并将数据保存到数据库</h3><p>在这里我们使用 mongoose 接收数据。</p>
<p>mongoose 是一个文档对象模型库（ODM），它的语法和 mongodb 里的 shell 命令是一样的。如果你使用过 node.js 直接操作 mongodb，你会发现代码中会出现很多嵌套、回调以及各种潜在问题。但有了 mongoose，你可以直接在 node.js 里使用 mongoose 自身的语法，不仅代码简洁，操作数据方便，而且避免了很多额外的问题。</p>
<p>如果你想了解 mongoose 更多的内容，可访问：</p>
<ul>
<li>Mongoose官网：<a href="http://www.nodeclass.com/api/mongoose.html" target="_blank" rel="noopener">http://www.nodeclass.com/api/mongoose.html</a></li>
<li>Mongoose学习参考文档：<a href="https://cnodejs.org/topic/504b4924e2b84515770103dd" target="_blank" rel="noopener">https://cnodejs.org/topic/504b4924e2b84515770103dd</a></li>
<li>Mongoose优势是什么，为什么我们要使用它：<a href="http://stackoverflow.com/questions/18531696/why-do-we-need-what-advantages-to-use-mongoose" target="_blank" rel="noopener">http://stackoverflow.com/questions/18531696/why-do-we-need-what-advantages-to-use-mongoose</a></li>
</ul>
<p>老规矩，要使用它，就得先安装它：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm install mongoose --save</span><br></pre></td></tr></table></figure>
<p>安装完毕后，在 data 文件夹下新增 mongoose.js 文件，它的代码如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/blog'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blogSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    content: &#123;<span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">unique</span>:<span class="literal">true</span>&#125;, <span class="comment">// unique 保证数据的唯一，但有时候不管用</span></span><br><span class="line">    date: <span class="built_in">String</span></span><br><span class="line">&#125;, &#123;<span class="attr">collection</span>: <span class="string">'post'</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> post = mongoose.model(<span class="string">'post'</span>, blogSchema);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = post;</span><br></pre></td></tr></table></figure>
<p>然后在根目录下 app.js 里的 <code>var app = express();</code> 下一行增加以下代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">global.post = <span class="built_in">require</span>(<span class="string">'./data/mongoose'</span>);</span><br></pre></td></tr></table></figure>
<p>因为前面ajax是将数据 post 到 index.html 页面，因此我们需要在 index.js 处理 post 的请求。在 index.js 里新增代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* POST home page. */</span></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">var</span> content = req.body.content;</span><br><span class="line">    <span class="keyword">var</span> date = req.body.date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (content &amp;&amp; date) &#123;</span><br><span class="line">        <span class="keyword">var</span> newPost = <span class="keyword">new</span> post(&#123;</span><br><span class="line">            content: content,</span><br><span class="line">            date: date</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        newPost.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// newPost is saved!</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'保存成功！'</span>);</span><br><span class="line">            res.send(<span class="number">200</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>此时，我们使用以下命令重启服务：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm start</span><br></pre></td></tr></table></figure>
<p>刷新页面，然后在文本框里输入 ‘夜晚，这是一个很安静的夜晚！’ ，点击 ‘发布’ 按钮后，会弹出 ‘发布成功！’ 的提示。</p>
<p>然后，我们在操作数据库的命名行面板中，输入查找命令，即可打印出我们刚才发布的内容，这也说明数据在数据库里保存成功了。</p>

<h3 id="4-3-读取数据库数据并将数据显示至页面"><a href="#4-3-读取数据库数据并将数据显示至页面" class="headerlink" title="4.3 读取数据库数据并将数据显示至页面"></a>4.3 读取数据库数据并将数据显示至页面</h3><p>保存完数据后，我们刷新浏览器的页面，但是发现刚才保存的 ‘夜晚，这是一个很安静的夜晚！’ 这条数据并未在页面中显示出来。这是为什么？</p>
<p>因为在刚才的操作中，我们只是点击 ‘发布’ 按钮，将数据 post 到博客首页，并将数据保存到数据库。但是博客首页刷新后，我们并没有写任何读取数据库的代码。</p>
<p>因此，需要在博客首页刷新时（也就是 get 时），去读取数据库，并把读取的数据发送给前端模板，再通过模板把这些数据渲染出来。</p>
<p>首先，我们将 index.js 里的：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'博客首页'</span>, <span class="attr">name</span>: <span class="string">'博客'</span>&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    post.find(&#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, docs</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// docs 是包含了符合条件的多个文档的一个数组</span></span><br><span class="line">        <span class="comment">// console.log(docs);</span></span><br><span class="line">        res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'博客首页'</span>, <span class="attr">name</span>: <span class="string">'博客'</span>, <span class="attr">content</span>: docs.reverse()&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在这里，<code>docs</code> 是读取数据库后返回的数据，它是一个数组，我使用了 <code>docs.reverse()</code> 对数组进行反转，也就是让最新的数据，渲染在博客列表的最前面。</p>
<p>然后，我们再回到模板里。因为，后台返回给前台的数据是动态的，因此也需要对 index.html 中的列表部分进行修改，将 index.html 里的：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"blog"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"blog-list"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"blog-item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-content"</span>&gt;</span>你好<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-extra"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"date"</span>&gt;</span>2015-10-10<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"delete"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"update"</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"blog"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"blog-list"</span>&gt;</span></span><br><span class="line">        &lt;% for(var i=0; i&lt;content.length; i++) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"blog-item"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-content"</span>&gt;</span><span class="tag">&lt;<span class="name">%-</span> <span class="attr">content</span>[<span class="attr">i</span>]<span class="attr">.content</span> %&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"blog-extra"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"date"</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">content</span>[<span class="attr">i</span>]<span class="attr">.date</span> %&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"delete"</span> <span class="attr">data-content</span>=<span class="string">"&lt;%= content[i].content %&gt;"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"update"</span> <span class="attr">data-content</span>=<span class="string">"&lt;%= content[i].content %&gt;"</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>关于模板的用法和写法，可参考 ejs 的相关文档。</p>
<p>好了，我们再次刷新页面，便能看到 ‘夜晚，这是一个很安静的夜晚！’ 这条数据了。</p>

<p>是不是感觉很棒！</p>
<p>文章写到这里，我们已经完成了 express 的搭建、模板的使用、mongodb 数据的存储和读取等这些非常重要的步骤，这也意味着博客系统已经完成一大半了。</p>
<p>接下来，我们继续完成博客的删除和更新。</p>
<h3 id="4-4-数据的删除与更新"><a href="#4-4-数据的删除与更新" class="headerlink" title="4.4 数据的删除与更新"></a>4.4 数据的删除与更新</h3><p>在前面的操作中，细心的你或许已经注意到 index.html 列表里有这样的代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"delete"</span> <span class="attr">data-content</span>=<span class="string">"&lt;%= content[i].content %&gt;"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"update"</span> <span class="attr">data-content</span>=<span class="string">"&lt;%= content[i].content %&gt;"</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>是的，这里的 <code>content[i].content</code> 就是每条博客的内容。当点击 ‘删除’ 和 ‘更新’ 这个按钮时，我们会根据它的 <code>data-content</code> 属性来获取这条博客的内容，然后对符合内容的数据进行删除和更新操作。</p>
<h3 id="4-5-数据的删除"><a href="#4-5-数据的删除" class="headerlink" title="4.5 数据的删除"></a>4.5 数据的删除</h3><p>和发送博客类似，这里的删除操作也是通过发送 ajax 给后台，在 index.html 里的js部分，新增以下js代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 删除</span></span><br><span class="line">$(<span class="string">'.delete'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> deleteContent = $(<span class="keyword">this</span>).attr(<span class="string">'data-content'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> postData = &#123;</span><br><span class="line">        <span class="string">'deleteContent'</span>: deleteContent</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (confirm(<span class="string">'您确定要删除这条博客吗？'</span>)) &#123;</span><br><span class="line">        $.ajax(&#123; </span><br><span class="line">            url: <span class="string">'/'</span>,</span><br><span class="line">            type: <span class="string">'post'</span>,</span><br><span class="line">            data: postData,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// alert('成功！');</span></span><br><span class="line">                location.href = <span class="string">'/'</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123; </span><br><span class="line">                <span class="comment">// alert('失败！');</span></span><br><span class="line">                location.href = <span class="string">'error'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>前台页面发送了 post 提交请求，那后台就需要处理这个 post 请求。于是，index.js 新增删除数据的代码，即 index.js 中的 <code>router.post</code> 部分更新为：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* POST home page. */</span></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">var</span> content = req.body.content;</span><br><span class="line">    <span class="keyword">var</span> date = req.body.date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (content &amp;&amp; date) &#123;</span><br><span class="line">        <span class="keyword">var</span> newPost = <span class="keyword">new</span> post(&#123;</span><br><span class="line">            content: content,</span><br><span class="line">            date: date</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        newPost.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// newPost is saved!</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'保存成功！'</span>);</span><br><span class="line">            res.send(<span class="number">200</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> deleteContent = req.body.deleteContent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deleteContent) &#123;</span><br><span class="line">        post.remove(&#123;<span class="attr">content</span>: deleteContent&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'删除成功！'</span>);</span><br><span class="line">            res.send(<span class="number">200</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>嗯，删除数据的功能基本完成。我们运行下重启服务的命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm start</span><br></pre></td></tr></table></figure>
<p>刷新浏览器页面，发布一条内容为 ‘abcd’ 的博客后，然后点 ‘删除’ 按钮，首先它会提示你 ‘您确定要删除这条博客吗？’ ，点击 ‘确定’ 按钮后，页面刷新， ‘abcd’ 这条博客就在页面里被删除了。你也可以在数据库命令面板中运行 <code>db.post.find()</code>，查看该条数据是否真的已删除。</p>
<h3 id="4-6-数据的更新"><a href="#4-6-数据的更新" class="headerlink" title="4.6 数据的更新"></a>4.6 数据的更新</h3><p>数据的更新有点特别，这点在文章的开头也能看出。因为博客的更新是在 update.html 完成的，你可以先回到前面看下博客更新页的UI界面。</p>
<p>然后，我们来描述下博客更新的流程，主要分为3步：</p>
<ol>
<li>在博客首页点击 ‘更新’ 按钮后，将该条博客的内容作为更新页地址的参数，并且此时，页面跳转到博客更新页(update.html)。简单来说，就是把博客内容带到更新页。</li>
<li>在博客更新页读取url里的参数，并将它赋值给文本框中。然后在文本框修改博客内容，点击文本框底部右边的 ‘更新’ 按钮，将文本框里的内容通过ajax的方式 post 到博客首页。其实这里的更新操作和博客首页的发布博客类似。</li>
<li>post 到博客首页后，页面将会跳转到博客首页，博客首页在后台处理 post 请求，mongoose代码更新该条博客数据，并将新的博客内容显示出来。</li>
</ol>
<p>流程说完，接着我们来把它们转换成代码：</p>
<p>第一步，在 index.html 中新增js代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新跳转</span></span><br><span class="line">$(<span class="string">'.update'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> updateContent = $(<span class="keyword">this</span>).attr(<span class="string">'data-content'</span>);</span><br><span class="line">    location.href = <span class="string">'/update?updateBlog='</span> + updateContent;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>第二步，在 update.html 中新增js代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"/javascripts/jquery.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从url读取要更新的内容，简单粗暴处理</span></span><br><span class="line">    <span class="keyword">var</span> oldContent = <span class="built_in">decodeURI</span>(<span class="built_in">window</span>.location.search.substr(<span class="number">12</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置它到文本域，并保留换行</span></span><br><span class="line">    $(<span class="string">'.textarea-add'</span>).val(oldContent.replace(<span class="regexp">/\&lt;br\/&gt;/g</span>, <span class="string">'\n'</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    $(<span class="string">'.btn-update'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> updateContent = $(<span class="string">'.textarea-add'</span>).val().trim().replace(<span class="regexp">/\n/g</span>, <span class="string">'&lt;br/&gt;'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (updateContent === oldContent) &#123;</span><br><span class="line">            alert(<span class="string">'内容没有更新！'</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> postData = &#123;</span><br><span class="line">            <span class="string">'oldContent'</span>: oldContent,</span><br><span class="line">            <span class="string">'updateContent'</span>: updateContent</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        $.ajax(&#123; </span><br><span class="line">            url: <span class="string">'/'</span>,</span><br><span class="line">            type: <span class="string">'post'</span>,</span><br><span class="line">            data: postData,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">                alert(<span class="string">'更新成功！'</span>);</span><br><span class="line">                location.href = <span class="string">'/'</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123; </span><br><span class="line">                alert(<span class="string">'更新失败！'</span>);</span><br><span class="line">                location.href = <span class="string">'error'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;); </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里需要注意下，url里的参数必须 decodeURI 转码下才能赋值给文本框，并且html标签里的换行（<code>&lt;br/&gt;</code>）与文本框的换行（<code>\n</code>）也是不同的，在读取操作时也要进行特殊处理。还有，如果博客内容没有发生变化，要给予提示。</p>
<p>第三步，将 index.js 中的 <code>router.post</code> 部分更新为：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* POST home page. */</span></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">var</span> content = req.body.content;</span><br><span class="line">    <span class="keyword">var</span> date = req.body.date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (content &amp;&amp; date) &#123;</span><br><span class="line">        <span class="keyword">var</span> newPost = <span class="keyword">new</span> post(&#123;</span><br><span class="line">            content: content,</span><br><span class="line">            date: date</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        newPost.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// newPost is saved!</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'保存成功！'</span>);</span><br><span class="line">            res.send(<span class="number">200</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> deleteContent = req.body.deleteContent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deleteContent) &#123;</span><br><span class="line">        post.remove(&#123;<span class="attr">content</span>: deleteContent&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'删除成功！'</span>);</span><br><span class="line">            res.send(<span class="number">200</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> oldContent = req.body.oldContent,</span><br><span class="line">        updateContent = req.body.updateContent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldContent &amp;&amp; updateContent) &#123;</span><br><span class="line">        post.update(&#123;<span class="attr">content</span>: oldContent&#125;, &#123;<span class="attr">$set</span>: &#123;<span class="string">'content'</span>: updateContent&#125;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(err);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'更新成功！'</span>);</span><br><span class="line">            res.send(<span class="number">200</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>老规矩，我们运行重启服务的命令，来检测下更新博客的功能：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm start</span><br></pre></td></tr></table></figure>
<p>刷新浏览器页面，首先我们发布一条内容为 ‘123’ 的博客后，然后点 ‘更新’ 按钮，页面跳转到博客更新页，在文本框里将 ‘123’ 更新为  ‘456’，再点 ‘更新’ 按钮后，页面会提示 ‘更新成功！’ ，并且此时，页面将跳转到博客首页，你也将看到之前 ‘123’ 的博客被更新为 ‘456’。</p>
<p>至此，我们的博客系统就 ‘完美竣工’ 了！</p>
<h2 id="五、启动项目"><a href="#五、启动项目" class="headerlink" title="五、启动项目"></a>五、启动项目</h2><p>博客系统的源码我已打包出来，点击底下链接进行下载：</p>
<a href="/2016/04/09/a-light-blog-with-express-and-mongodb/blog.zip" title="极简博客系统">极简博客系统</a>
<p>下载完后，首先在下载项目的根目录打开命令行面板，安装依赖：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm install</span><br></pre></td></tr></table></figure>
<p>依赖安装完后，在任意目录，打开另外一个命令行面板，设置数据库目录，并启动 mongodb 数据库。通过以下命令（数据存在根目录 data 文件夹下）：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; mongod.exe --dbpath 项目路径\data</span><br></pre></td></tr></table></figure>
<p>回到项目根目录的命令行面板，输入以下命令，启动服务：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; npm start</span><br></pre></td></tr></table></figure>
<p>在浏览器中，打开 <a href="http://localhost:3000/" target="_blank" rel="noopener">http://localhost:3000/</a></p>
<h2 id="六、结语"><a href="#六、结语" class="headerlink" title="六、结语"></a>六、结语</h2><p>虽然是一个极简的博客发布系统，但由于其中牵涉到前端web、模板引擎、服务器端框架、数据库存储及操作等各项技术，它们中的每一项都有自己的体系，况且要把这些技术恰如其分的组合起来，去完成一个web应用的开发，还真不是那么轻松的事。更何况，本文所应用到的，都只是它们的皮毛而已。</p>
<p>最后，以上内容均为个人研究和摸索，可能存在不足，欢迎邮件指出，同时也希望本文内容对你有所帮助！</p>

  </div>

</div>

  <div class="footer">
    <a href="http://www.yi-jy.com">前端技术空间--易建勇</a> /
    <a href="http://www.beianbeian.com/search/yi-jy.com">Copyright © 2012-2018</a> /
    <a href="https://github.com/joy-yi0905/hexo-theme-record">Record</a> /
    <a href="http://yi-jy.com/atom.xml">Rss</a>
  </div>

</div>

</body>


    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?7d5550c80ba3b42cfa5323fc0e92699f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


</html>